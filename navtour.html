<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
        <script src="rec_facial.js"></script>
        <link rel="icon" href="360images/icons/logo.png" type="image/x-icon">
        <link rel = "stylesheet" type = "text/css" href = "tour.css">
        <title>DEVEETOUR</title>
    </head>
    <body>

        <!-- initial loading screen animation -->
        <div id="initial-loading">
            <h2>Cargando...</h2>
        </div>

        <!-- structuring loading screen -->
        <div id="loading-screen">
            <img id="loading-logo" src="360images/icons/logo.png" alt="Logo DEVEESITES" loading="lazy">
            <h2>Recorrido virtual FACPyA</h2>
            <h1>Diseñado por DEVEESITES</h1>
            <button class="glass-button" onclick="startTour()" aria-label="Iniciar recorrido">Iniciar recorrido</button>
            <button class="glass-button" onclick="goToMain()" aria-label="Volver a la página principal">Volver a la página principal</button>
        </div>

        <!--buttons (back & help)-->
        <div id="buttons-container">
            <button id="backBtn" onclick="returnToLoading()">
                <img src="360images/icons/arrowback.png" alt="Back" class="icon-btn">
            </button>
            <button id="helpBtn" onclick="showHelp()">
                <img src="360images/icons/question.png" alt="Help" class="icon-btn">
            </button>
        </div>
 
        <!-- Menú desplegable minimalista -->
        <div id="dropdown-menu-container">
            <button id="dropdown-button" onclick="toggleDropdownMenu()">Seleccionar Ubicación</button>
            <div id="dropdown-menu" style="display: none;">
                <!-- Las opciones del menú se generarán dinámicamente -->
            </div>
        </div>

        <!-- Modal de ayuda -->
        <div id="help-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeHelp()">&times;</span>
                <h2>Instrucciones de uso</h2>
                <p>1. Utiliza los botones para iniciar el recorrido o volver a la página principal.</p>
                <p>2. Usa la barra de búsqueda para encontrar ubicaciones específicas.</p>
                <p>3. Desplázate por la barra de rutas para ver las ubicaciones disponibles.</p>
                <p>4. Presiona los hotspots para navegar entre escenas.</p>
                <p>¡Disfruta del recorrido virtual!</p>
            </div>
        </div>

        <!-- structuring route container -->
        <div id="route-container"></div>

        <!-- structuring map container -->
        <div id="map-container"></div>

        <!-- Modal para previsualización de imágenes -->
        <div id="image-preview-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeImagePreview()">&times;</span>
                <img id="preview-image" src="" alt="Previsualización" style="width: 100%; height: auto; border-radius: 10px;">
            </div>
        </div>

        <!-- ventana informativa -->
        <div id="info-box">
            <div id="info-box-header">
                <button id="close-btn" onclick="closeInfo()">✖</button>
            </div>
            <h1 id="dept-name"></h1>
            <p id="info-box-time"></p>
            <div id="image-container">
                <img id="info-image" class="main-img" src="" alt="imagen del lugar" onclick="openImagePreview(this.src)">
                <div id="thumbnail-container"></div>
            </div>
            <p id="info-content"></p>
            <pre id="info-contact" class="contact-info"></pre>
            <div id="gallery-modal" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="closeGallery()">✖</span>
                    <div id="gallery-content"></div>
                </div>
            </div>

            <!--full screen modal-->
            <div id="full-screen-modal" class="modal">
                <span class="close" onclick="closeFullScreen()">✖</span>
                <img id="full-screen-image" class="full-screen-img">
            </div>

        </div>

        <a-scene cursor="rayOrigin: mouse">
            <a-light type="ambient" intensity="0.5"></a-light>
            <!-- aframe camera -->
            <a-camera id="main-camera" position="0 1.6 0" fov="80">
            </a-camera>

            <!-- start image -->
            <a-sky id="panorama" src="360images/Entrada/1.webp"></a-sky>

            <!-- hotspots container -->
            <a-entity id="hotspot-container"></a-entity>

        </a-scene>

        <script>
            // Componente de A-Frame para manejar gestos en los hotspots
            AFRAME.registerComponent('gesture-handler', {
                init: function () {
                    const sceneName = this.el.getAttribute('data-scene'); // Obtener el nombre de la escena del atributo
                    this.el.addEventListener('click', () => openInfo(sceneName));

                    // Capturar toques en dispositivos móviles (tap)
                    this.el.addEventListener('touchstart', (event) => {
                        event.preventDefault();
                        openInfo(sceneName);
                    });
                }
            });

            // abrir la ventana informativa
            function openInfo(departamento) {
            const infoBox = document.getElementById('info-box');
            const infoTitle = document.getElementById('dept-name');
            const infoTime = document.getElementById('info-box-time');
            const mainImage = document.getElementById('info-image');
            const infoDescription = document.getElementById('info-content');
            const infoContact = document.getElementById('info-contact');
            const thumbnailContainer = document.getElementById('thumbnail-container');

            // se obtiene la info de cada dpto
            const info = departamentos[departamento];

            if (info) {
                // actualizar datos
                infoTitle.textContent = info.titulo;
                infoTime.textContent = info.horario;
                mainImage.src = info.imagenesVentana[0];
                mainImage.onclick = () => openFullScreen(info.imagenesVentana[0]);
                infoDescription.textContent = info.descripcion;
                infoContact.textContent = info.contacto;

                thumbnailContainer.innerHTML = '';
                const maxThumbnails = 2; // mostrar dos miniaturas

                info.imagenesVentana.slice(1, maxThumbnails).forEach((imgSrc) => {
                    const thumbnail = document.createElement('img');
                    thumbnail.src = imgSrc;
                    thumbnail.alt = "Miniatura";
                    thumbnail.classList.add('thumbnail');
                    thumbnail.onclick = () => openFullScreen(imgSrc); // ampliar imagen al hacer clic
                    thumbnailContainer.appendChild(thumbnail);
                });

                // "+x" si hay mas imgs
                if (info.imagenesVentana.length > maxThumbnails) {
                    const moreImages = document.createElement("div");
                    moreImages.classList.add("more-thumbnails");
                    moreImages.innerText = `+${info.imagenesVentana.length - maxThumbnails}`;
                    moreImages.onclick = () => openGallery(info.imagenesVentana);
                    thumbnailContainer.appendChild(moreImages);
                }

                // mostrar la ventana con block
                infoBox.style.display = 'block';
                setTimeout(() => {
                    infoBox.style.right = '0';
                }, 10);
            }
        }

            // abrir el modal de + imagenes
            function openGallery(images) {
            const modal = document.getElementById("gallery-modal");
            const modalContent = document.getElementById("gallery-content");
            modalContent.innerHTML = "";

            images.forEach((imgSrc) => {
                const img = document.createElement("img");
                img.src = imgSrc;
                img.classList.add("gallery-img");
                img.onclick = () => openFullScreen(imgSrc);
                modalContent.appendChild(img);
            });

            modal.style.display = "block";
        }

            // cerrar el modal de la galeria de imagenes
            function closeGallery() {
                const modal = document.getElementById("gallery-modal");
                modal.style.display = "none";
            }

            // cerrar ventana de info
            function closeInfo(event) {
                const infoBox = document.getElementById("info-box");

                if (event && infoBox.contains(event.target)) {
                    return;
                }

                infoBox.style.right = "-400px";
                setTimeout(() => {
                    infoBox.style.display = "none";
                }, 500);
            }

            // abrir el modal para ver imgs
            function openImagePreview(imageSrc) {
                const modal = document.getElementById("image-preview-modal");
                const previewImage = document.getElementById("preview-image");
                previewImage.src = imageSrc;
                modal.style.display = "block";
            }

            // cerrarlo :D
            function closeImagePreview() {
                const modal = document.getElementById("image-preview-modal");
                modal.style.display = "none";
            }

            // abrir imagen fullscreen
            function openFullScreen(imgSrc) {
            const fullScreenModal = document.getElementById("full-screen-modal");
            const fullScreenImage = document.getElementById("full-screen-image");

            fullScreenImage.src = imgSrc;
            fullScreenModal.style.display = "flex";
        }

            // cerrar el fullscreen
            function closeFullScreen() {
                document.getElementById("full-screen-modal").style.display = "none";
            }

            // evitar cierres automaticos
            document.addEventListener("click", function (event) {
                const previewModal = document.getElementById("image-preview-modal");
                const galleryModal = document.getElementById("gallery-modal");
                const fullScreenModal = document.getElementById("full-screen-modal");
                
                if (event.target === previewModal) {
                    closeImagePreview();
                }

                if (event.target === galleryModal) {
                    closeGallery();
                }

                if (event.target === fullScreenModal) {
                    closeFullScreen();
                }
            });

            let currentScene = "Entrada"; // escena actual
            document.addEventListener("DOMContentLoaded", () => {
                const initialLoading = document.getElementById("initial-loading");
                const loadingScreen = document.getElementById("loading-screen");
                const backBtn = document.getElementById("backBtn");
                const helpBtn = document.getElementById("helpBtn");
                const routeContainer = document.getElementById("route-container");
                //const dropdownMenu = document.getElementById("dropdown-menu-container");

                // Ocultar el contenedor de carga inicial después de 2 segundos
                setTimeout(() => {
                    initialLoading.style.display = "none"; // Ocultar completamente del flujo del DOM
                }, 2000);

                // Mostrar la pantalla principal del menú después de 2 segundos
                setTimeout(() => {
                    loadingScreen.style.display = "flex"; // Asegúrate de que se muestre el menú principal
                }, 2000);

                // botones y ruta ocultos al iniciar
                backBtn.style.display = "none";
                helpBtn.style.display = "none"
                routeContainer.style.display = "none";
                //dropdownMenu.style.display = "none";

                // Función para abrir la galería solo al hacer clic en el +X
                document.getElementById("gallery-button").addEventListener("click", function (event) {
                    event.stopPropagation(); // Evita que el clic se propague y cierre otros elementos
                    openGallery(departamentos[departamento].imagenesVentana);
                });

                // Asegurar que las imágenes en miniatura solo abran pantalla completa cuando se haga clic en ellas
                document.querySelectorAll(".thumbnail").forEach((thumbnail) => {
                    thumbnail.addEventListener("click", function (event) {
                        event.stopPropagation(); // Evita que se cierre el modal al hacer clic en una imagen
                        openFullScreen(this.src);
                    });
                });

                // Prevenir que la ventana informativa active eventos de cierre de modales
                document.getElementById("info-box").addEventListener("click", function (event) {
                    event.stopPropagation();
                });

                // Cerrar modales al hacer clic fuera de su contenido
                document.addEventListener("click", function (event) {
                    const galleryModal = document.getElementById("gallery-modal");
                    const fullScreenModal = document.getElementById("full-screen-modal");

                    if (event.target === galleryModal) closeGallery();
                    if (event.target === fullScreenModal) closeFullScreen();
                });
            });

            // iniciar el recorrido
            function startTour() {
                const loadingScreen = document.getElementById("loading-screen");
                const backBtn = document.getElementById("backBtn");
                const helpBtn = document.getElementById("helpBtn")
                const scene = document.querySelector("a-scene");
                const routeContainer = document.getElementById("route-container");
                //const dropdownMenu = document.getElementById("dropdown-menu-container");

                loadingScreen.style.display = "none"; // Ocultar la pantalla de carga
                scene.style.display = "block"; // Mostrar la escena
                scene.style.filter = "none"; // Quitar el efecto de desenfoque

                if (backBtn) {
                    backBtn.style.display = 'block'; // Mostrar el botón
                    backBtn.style.pointerEvents = 'auto';
                    backBtn.style.opacity = '1';
                }

                if (helpBtn) {
                    helpBtn.style.display = "block";
                    helpBtn.style.pointerEvents = "auto";
                    helpBtn.style.opacity = "1";
                }

                routeContainer.style.display = "flex"; // Mostrar el contenedor de rutas
                searchContainer.style.display = "flex"; // Mostrar la barra de búsqueda
                //dropdownMenu.style.display = "flex";

                showRoute(currentScene); // Mostrar la ruta inicial
            }

            // Función para volver a la pantalla de carga
            function returnToLoading() {
                const loadingScreen = document.getElementById("loading-screen");
                const scene = document.querySelector("a-scene");
                const backBtn = document.getElementById("backBtn");
                const routeContainer = document.getElementById("route-container");
                
                // Mostrar la pantalla de carga con efecto de desenfoque
                loadingScreen.style.display = "flex";
                scene.style.filter = "blur(10px)";

                // Efecto de iluminación al clickear el botón
                backBtn.style.pointerEvents = "none";
                backBtn.style.opacity = "0.5";

                // Ocultar el botón de regreso
                backBtn.style.display = "none";
                routeContainer.style.display = "none"; // Mostrar el contenedor de rutas
                searchContainer.style.display = "none"; // Mostrar la barra de búsqueda
            }

            const mapContainer = document.getElementById("map-container");
            // Función para mostrar el mapa
            function showMap() {
                console.log('Mostrando el mapa');
                mapContainer.style.display = 'block';
                mapContainer.classList.add('fade-in');
                setTimeout(() => {
                    mapContainer.classList.remove('fade-in');
                }, 500);
            }

            // Función para ocultar el mapa
            function hideMap() {
                console.log('Ocultando el mapa');
                mapContainer.classList.add('fade-out');
                setTimeout(() => {
                    mapContainer.style.display = 'none';
                    mapContainer.classList.remove('fade-out');
                }, 500);
            }

            // Función para crear un marcador en el mapa
            function createMarker(sceneName, position) {
                const marker = document.createElement('div');
                marker.className = 'map-marker';
                marker.style.left = `${position.x}px`;
                marker.style.top = `${position.y}px`;
                marker.addEventListener('click', () => {
                    loadScene(sceneName);
                    hideMap();
                });
                mapContainer.appendChild(marker);
            }

            // Función para crear una ruta en el mapa
            function createRoute(startPos, endPos) {
                console.log(`Creando ruta desde ${startPos} hasta ${endPos}`);
                const route = document.createElement('div');
                route.className = 'map-route';
                route.style.left = `${startPos.x}px`;
                route.style.top = `${startPos.y}px`;
                route.style.height = `${Math.sqrt(Math.pow(endPos.x - startPos.x, 2) + Math.pow(endPos.y - startPos.y, 2))}px`;
                route.style.transform = `rotate(${Math.atan2(endPos.y - startPos.y, endPos.x - startPos.x)}rad)`;
                mapContainer.appendChild(route);
            }

            // Función para mostrar la ruta en el mapa
            function showRouteOnMap(route) {
                console.log('Mostrando ruta en el mapa:', route);
                mapContainer.innerHTML = ''; // Limpiar el mapa
                route.forEach((scene, index) => {
                    const position = { x: index * 50 + 20, y: 150 }; // Posiciones de ejemplo
                    createMarker(scene, position);
                    if (index > 0) {
                        const prevPosition = { x: (index - 1) * 50 + 20, y: 150 };
                        createRoute(prevPosition, position);
                    }
                });
            }

            // reanudar el recorrido
            function resumeTour() {
                const loadingScreen = document.getElementById("loading-screen");
                const scene = document.querySelector("a-scene");
                const backBtn = document.getElementById("backBtn");
                const helpBtn = document.getElementById("helpBtn");
                const resumeBtn = document.getElementById("resume-tour");
                const routeContainer = document.getElementById("route-container");

                // Ocultar la pantalla de carga y quitar el efecto de desenfoque
                loadingScreen.style.display = "none";
                scene.style.filter = "none";

                // Mostrar el botón de regreso
                backBtn.style.display = "block";
                backBtn.style.pointerEvents = "auto";
                backBtn.style.opacity = "1";

                helpBtmn.style.display = "block";
                helpBtn.style.pointerEvents = "auto";
                helpBtn.style.opacity = "1";

                // Ocultar el botón de reanudar
                resumeBtn.style.display = "none";

                // Mostrar el contenedor de rutas
                routeContainer.style.display = "flex";
                showRoute(currentScene); // Mostrar la ruta actual
            }

            // Función para alternar la visibilidad del menú desplegable
            function toggleDropdownMenu() {
                const dropdownMenu = document.getElementById("dropdown-menu");
                dropdownMenu.style.display = dropdownMenu.style.display === "none" ? "block" : "none";
            }

            // Función para generar las opciones del menú desplegable
            function populateDropdownMenu() {
                const dropdownMenu = document.getElementById("dropdown-menu");
                dropdownMenu.innerHTML = ""; // Limpiar el menú antes de agregar opciones

                Object.keys(scenes).forEach(sceneName => {
                    const button = document.createElement("button");
                    button.textContent = scenes[sceneName].name || sceneName; // Mostrar el nombre de la escena
                    button.onclick = () => {
                        loadScene(sceneName); // Cargar la escena seleccionada
                        toggleDropdownMenu(); // Cerrar el menú después de seleccionar
                    };
                    dropdownMenu.appendChild(button);
                });
            }

            // Llamar a la función para generar el menú al cargar la página
            document.addEventListener("DOMContentLoaded", populateDropdownMenu);

            // Función para volver a la página principal
            function goToMain() {
                window.location.href = "https://deveesites.com/"; 
            }

            const departamentos = {
                "Entrada": {
                    titulo: "Entrada principal",
                    horario: "06:50 p.m. 08:32 p.m.",
                    descripcion: "Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor",
                    imagen: "360images/icons/info_icon.png",
                    contacto: "8122568614\nomomomom@gmail.com\nwww.hola.com",
                    posicion: "0 1.5 -3",
                    imagenesVentana: ["Statics/Entrada.jpg", "Statics/Auditorio.jpg", "Statics/Biblioteca.jpg",
                        "Statics/Entrada.jpg", "Statics/Finanzas.jpg", "Statics/Stic.jpg", "Statics/Entrada.jpg", "Statics/Entrada.jpg"] // Imágenes para la ventana
                },
                "Lobby": {
                    titulo: "Lobby Central",
                    descripcion: "El corazón de FACPyA, donde convergen estudiantes y profesores.",
                    imagen: "360images/icons/info_icon.png",
                    contacto: "Email: lobby@facpya.com",
                    posicion: "0.5 1.3 -2", // Ajusta la posición según tu escena
                    imagenesVentana: ["Statics/Auditorio.jpg"] // Imágenes para la ventana
                },
                "Pasillo":{
                    titulo: "Pasillo Principal",
                    descripcion: "Pasillo principal de la facultad.",
                    imagen: "360images/icons/info_icon.png",
                    contacto: "Email: pasillo@facpya.com",
                    posicion: "0 1 -2",
                    imagenesVentana: ["Statics/Entrada.jpg"] // Imágenes para la ventana
                },
                "Intercambio":{
                    titulo: "Departamento de Intercambio",
                    descripcion: "Departamento de intercambio estudiantil.",
                    imagen: "360images/icons/info_icon.png",
                    contacto: "Email: intercambio@facpya.com",
                    posicion: "0 1 -1", // Ajusta la posición según tu escena
                    rotation: "0 0 0",
                    imagenesVentana: ["Statics/Intercambio.jpg"] // Imágenes para la ventana
                },
                "Titulación":{
                    titulo: "Departamento de Titulación",
                    descripcion: "Departamento de titulación.",
                    imagen: "360images/icons/info_icon.png",
                    contacto: "Email: titulacion@facpya.com",
                    posicion: "0 1 -1", // Ajusta la posición según tu escena
                    rotation: "0 0 0",
                    imagenesVentana: ["Statics/Titulacion.jpg"] // Imágenes para la ventana
                },
                "Biblioteca":{
                    titulo: "Biblioteca",
                    descripcion: "Biblioteca de la facultad.",
                    imagen: "360images/icons/info_icon.png",
                    contacto: "Email: biblioteca@facpya.com",
                    posicion: "0 1 -1", // Ajusta la posición según tu escena
                    rotation: "0 0 0",
                    imagenesVentana: ["Statics/Biblioteca.jpg"] // Imágenes para la ventana
                },
                "Stic":{
                    titulo: "Centro de Cómputo STIC",
                    descripcion: "Centro de cómputo de la facultad.",
                    imagen: "360images/icons/info_icon.png",
                    contacto: "Email: stic@facpya.com",
                    posicion: "0 1 -1", // Ajusta la posición según tu escena
                    rotation: "0 0 0",
                    imagenesVentana: ["Statics/Stic.jpg"] // Imágenes para la ventana
                }
                // ... Agrega más departamentos con sus posiciones ...
            };
        

            // Definir escenas con sus respectivos hotspots
            const scenes = {
                Entrada: {
                    image: "360images/Entrada/1.webp",
                    hotspots: [
                        {
                            position: "-1 1 0",
                            targetScene: "Lobby",
                            geometry: "primitive: plane; height: 0.5; width: 0.5",
                            material: "src: 360images/icons/iconup.png; transparent: true",
                            rotation: "-90 90 0.5",
                        }
                    ],
                    name: "Entrada",
                },
                Lobby: {
                    image: "360images/Lobby/2.webp",
                    hotspots: [
                        {
                            position: "-1 1 0",
                            targetScene: "Pasillo",
                            geometry: "primitive: plane; height: 0.5; width: 0.5", // Personalización
                            material: "src: 360images/icons/iconup.png; transparent: true", // Personalización
                            rotation: "-90 90 45", // Personalización
                        },
                        {
                            position: "1 1 0",
                            targetScene: "Entrada",
                            geometry: "primitive: plane; height: 0.5; width: 0.5", // Personalización
                            material: "src: 360images/icons/icondown.png; transparent: true", // Personalización
                            rotation: "-90 90 0", // Personalización
                        }
                    ],
                    name: "Lobby",
                },
                Pasillo: {
                    image: "360images/Pasillo_principal/3.webp",
                    hotspots: [
                        {
                            position: "1 1 -0.20",
                            targetScene: "Lobby",
                            geometry: "primitive: plane; height: 0.5; width: 0.5", // Personalización
                            material: "src: 360images/icons/icondown.png; transparent: true", // Personalización
                            rotation: "-90 90 0", // Personalización
                        },
                        {
                            position: "0.2 1 1.2",
                            targetScene: "Intercambio",
                            geometry: "primitive: plane; height: 0.5; width: 0.5", // Personalización
                            material: "src: 360images/icons/iconup.png; transparent: true", // Personalización
                            rotation: "-90 90 90", // Personalización
                        }
                    ],
                    name: "Pasillo",
                },
                Intercambio: {
                    image: "360images/Intercambio/4.webp",
                    hotspots: [
                        {
                            position: "-0.3 1 1",
                            targetScene: "Pasillo",
                            geometry: "primitive: plane; height: 0.5; width: 0.5", // Personalización
                            material: "src: 360images/icons/icondown.png; transparent: true", // Personalización
                            rotation: "-90 90 -90", // Personalización
                        },
                        {
                            position: "-.5 1 -1",
                            targetScene: "Titulación",
                            geometry: "primitive: plane; height: 0.5; width: 0.5", // Personalización
                            material: "src: 360images/icons/iconup.png; transparent: true", // Personalización
                            rotation: "-90 90 -90", // Personalización
                        }
                    ],
                    name: "Intercambio",
                },
                Titulación: {
                    image: "360images/Titulacion/5.webp",
                    hotspots: [
                        {
                            position: "-0.3 1 1",
                            targetScene: "Intercambio",
                            geometry: "primitive: plane; height: 0.5; width: 0.5", // Personalización
                            material: "src: 360images/icons/icondown.png; transparent: true", // Personalización
                            rotation: "-90 90 -90", // Personalización
                        },
                        {
                            position: "-.5 1 -1",
                            targetScene: "Biblioteca",
                            geometry: "primitive: plane; height: 0.5; width: 0.5", // Personalización
                            material: "src: 360images/icons/iconup.png; transparent: true", // Personalización
                            rotation: "-90 90 -90", // Personalización
                        }           
                    ],
                    name: "Titulación",
                },
                Biblioteca: {
                    image: "360images/Biblioteca/6.webp",
                    hotspots: [
                        {
                            position: "-0.3 1 1",
                            targetScene: "Titulación",
                            geometry: "primitive: plane; height: 0.5; width: 0.5", // Personalización
                            material: "src: 360images/icons/icondown.png; transparent: true", // Personalización
                            rotation: "-90 90 -90", // Personalización
                        },
                        {
                            position: "-.5 1 -1",
                            targetScene: "Stic",
                            geometry: "primitive: plane; height: 0.5; width: 0.5", // Personalización
                            material: "src: 360images/icons/iconup.png; transparent: true", // Personalización
                            rotation: "-90 90 -90", // Personalización
                        }
                    ],
                    name: "Biblioteca",
                },
                Stic: {
                    image: "360images/cp_stic/7.webp",
                    hotspots: [
                        {
                            position: "-0.3 1 1",
                            targetScene: "Biblioteca",
                            geometry: "primitive: plane; height: 0.5; width: 0.5", // Personalización
                            material: "src: 360images/icons/icondown.png; transparent: true", // Personalización
                            rotation: "-90 90 -90", // Personalización
                        },
                        {
                            position: "-.5 1 -1",
                            targetScene: "Pasillo",
                            geometry: "primitive: plane; height: 0.5; width: 0.5", // Personalización
                            material: "src: 360images/icons/iconup.png; transparent: true", // Personalización
                            rotation: "-90 90 -90", // Personalización
                        }
                    ],
                    name: "Stic",
                },
            };

            const panorama = document.getElementById("panorama");
            const hotspotContainer = document.getElementById("hotspot-container");
            const cameraEl = document.getElementById("main-camera");
            
            function loadScene(sceneName) {
                // Cerrar la ventana informativa si está abierta
                closeInfo();
            
                const scene = scenes[sceneName];
                if (!scene) {
                    console.error(`Escena "${sceneName}" no encontrada.`);
                    return;
                }
            
                // Actualizar la escena actual
                currentScene = sceneName;
            
                // Añadir clase fade para la transición
                panorama.classList.add('fade');
                console.log('Clase fade añadida');
            
                // Cambiar la imagen del panorama después de un pequeño retraso para permitir la animación
                setTimeout(() => {
                    panorama.setAttribute("src", scene.image);
                    console.log('Imagen cambiada');
            
                    // Quitar la clase fade después de que la imagen cambie
                    panorama.addEventListener('load', () => {
                        panorama.classList.remove('fade');
                        console.log('Clase fade eliminada');
                    }, { once: true });
                }, 750); // Ajusta el tiempo según sea necesario
            
                // Actualizar los hotspots
                updateHotspots(scene);
            
                // Mostrar la ruta actualizada
                showRoute(currentScene);
            }

            //  
            function updateHotspots(scene) {
                // Limpiar los hotspots existentes
                while (hotspotContainer.firstChild) {
                    hotspotContainer.removeChild(hotspotContainer.firstChild);
                }

                // Add new hotspots with improved visibility
                scene.hotspots.forEach((hotspot) => {
                    const hotspotEl = document.createElement("a-entity");
                    
                    // Set initial attributes
                    hotspotEl.setAttribute("geometry", hotspot.geometry);
                    hotspotEl.setAttribute("material", {
                        src: hotspot.material.split('src: ')[1].split(';')[0],
                        transparent: true,
                        opacity: 0.8,  // Start with visible opacity
                        side: 'double' // Make the plane visible from both sides
                    });
                    
                    // Set position and rotation
                    hotspotEl.setAttribute("position", hotspot.position);
                    hotspotEl.setAttribute("rotation", hotspot.rotation);
                    
                    // Add billboard component to always face camera
                    hotspotEl.setAttribute("billboard", "");
                    
                    // Add animation for hover effect
                    hotspotEl.setAttribute("animation__hover", {
                        property: "scale",
                        dir: "alternate",
                        dur: 1000,
                        easing: "easeInOutSine",
                        loop: true,
                        to: "1.1 1.1 1.1"
                    });

                    // Add click event listener
                    hotspotEl.addEventListener("click", () => loadScene(hotspot.targetScene));
                    
                    // Add mouseenter/mouseleave events for hover effect
                    hotspotEl.addEventListener("mouseenter", function() {
                        this.setAttribute("material", "opacity", 1.0);
                    });
                    
                    hotspotEl.addEventListener("mouseleave", function() {
                        this.setAttribute("material", "opacity", 0.8);
                    });

                    hotspotContainer.appendChild(hotspotEl);
                    });

                    // Hotspots informativos
                    for (const departamento in departamentos) {
                        if (departamentos.hasOwnProperty(departamento)) {
                            const info = departamentos[departamento];
                            const posicion = info.posicion;
                        
                            // Verifica si el departamento debe mostrarse en la escena actual
                            if (scene.name === departamento) {
                                const infoHotspot = document.createElement("a-image");
                                infoHotspot.setAttribute("src", "360images/icons/info_icon.png"); // Asegúrate de tener este icono
                                infoHotspot.setAttribute("position", posicion);
                                infoHotspot.setAttribute("scale", "0.5 0.5 0.5");
                                infoHotspot.setAttribute("class", "clickable");
                                infoHotspot.setAttribute("data-scene", departamento); // Asigna el nombre del departamento
                                infoHotspot.setAttribute("gesture-handler", "");
                                hotspotContainer.appendChild(infoHotspot);
                            }
                        }
                    }
                }

            // Cargar la escena inicial
            loadScene("Entrada");

            // Definir rutas entre escenas
            const routes = {
                Entrada: ["Lobby"],
                Lobby: ["Entrada", "Pasillo"],
                Pasillo: ["Lobby", "Intercambio"],
                Intercambio: ["Pasillo", "Titulación"],
                Titulación: ["Intercambio", "Biblioteca"],
                Biblioteca: ["Titulación", "Stic"],
                Stic: ["Biblioteca", "Pasillo"]
            };

            // Función para encontrar la ruta más corta
            function findRoute(start, end) {
                const queue = [[start]];
                const visited = new Set();

                while (queue.length > 0) {
                    const path = queue.shift();
                    const node = path[path.length - 1];

                    if (visited.has(node)) continue;
                    visited.add(node);

                    if (node === end) {
                        return path;
                    }

                    const neighbors = routes[node] || [];
                    for (const neighbor of neighbors) {
                        const newPath = [...path, neighbor];
                        queue.push(newPath);
                    }
                }

                return null; // Ruta no encontrada
            }


            // Función para mostrar la ruta
            document.addEventListener("DOMContentLoaded", () => {
                const routeContainer = document.getElementById("route-container");

                routeContainer.addEventListener("scroll", () => {
                    updateVisibleLocations();
                });
            });

            function updateVisibleLocations() {
                const routeContainer = document.getElementById("route-container");
                const spans = routeContainer.querySelectorAll("span");
                const containerWidth = routeContainer.offsetWidth;
                const scrollLeft = routeContainer.scrollLeft;

                spans.forEach((span, index) => {
                    const spanLeft = span.offsetLeft;
                    const spanRight = spanLeft + span.offsetWidth;

                    if (spanLeft >= scrollLeft && spanRight <= scrollLeft + containerWidth) {
                        span.style.opacity = "1"; // Mostrar la ubicación
                    } else {
                        span.style.opacity = "0.5"; // Atenuar la ubicación
                    }
                });
            }

            function showRoute(currentScene) {
                const routeContainer = document.getElementById("route-container");
                const route = findRoute("Entrada", currentScene); // Ruta desde la Entrada hasta la escena actual

                if (route) {
                    // Mostrar todas las ubicaciones
                    routeContainer.innerHTML = route.map(scene => `<span>${scene}</span>`).join('<span>→</span>');

                    routeContainer.style.display = 'flex';
                    routeContainer.classList.add('fade-in');
                    setTimeout(() => {
                        routeContainer.classList.remove('fade-in');
                    }, 500);

                    // Actualizar las ubicaciones visibles al mostrar la ruta
                    updateVisibleLocations();
                } else {
                    routeContainer.innerHTML = '<span>Ruta no encontrada.</span>';
                    routeContainer.style.display = 'flex';
                    routeContainer.classList.add('fade-in');
                    setTimeout(() => {
                        routeContainer.classList.remove('fade-in');
                    }, 500);
                }
            }

            // Función para ocultar la ruta después de un tiempo
            function hideRoute() {
                const routeContainer = document.getElementById("route-container");
                routeContainer.classList.add('fade-out');
                setTimeout(() => {
                    routeContainer.style.display = 'none';
                    routeContainer.classList.remove('fade-out');
                }, 500);
            }

            // Ejemplo de uso: mostrar la ruta de 'Entrada' a 'Stic'
            showRoute("Entrada", "Stic");

            function searchLocation() {
                const searchInput = document.getElementById("search-input");
                const searchValue = searchInput.value.toLowerCase(); // Convertir el valor de búsqueda a minúsculas
                const sceneNames = Object.keys(scenes);
                const foundScene = sceneNames.find(scene => scene.toLowerCase().includes(searchValue)); // Convertir los nombres de las escenas a minúsculas para la comparación

                if (foundScene) {
                    const currentScene = getCurrentScene(); // Implementa esta función para obtener la escena actual
                    showRoute(currentScene, foundScene);
                    loadScene(foundScene);
                    searchInput.value = ""; // Limpiar el campo de Entrada después de la búsqueda

                    // Trackear la búsqueda exitosa
                    trackEvent('search-success', { query: searchValue, foundScene: foundScene });
                } else {
                    alert("Ubicación no encontrada.");

                    // Trackear la búsqueda fallida
                    trackEvent('search-fail', { query: searchValue });
                }
            }

            // Función para obtener la escena actual (implementa según tu lógica)
            function getCurrentScene() {
                // Lógica para obtener la escena actual
                return "Entrada"; // Ejemplo
            }

            // Función para crear un marcador en el mapa
            function createMarker(sceneName, position) {
                const marker = document.createElement('div');
                marker.className = 'map-marker';
                marker.style.left = `${position.x}px`;
                marker.style.top = `${position.y}px`;
                marker.addEventListener('click', () => {
                    loadScene(sceneName);
                    hideMap();
                });
                mapContainer.appendChild(marker);
            }

            

            // Zoom con ruedita del mouse
            document.addEventListener("wheel", (event) => {
                let fov = parseFloat(cameraEl.getAttribute("fov"));
                fov += event.deltaY * 0.05; // Ajustar sensibilidad
                fov = Math.max(30, Math.min(120, fov)); // Limitar zoom entre 30 y 120
                cameraEl.setAttribute("fov", fov);
            });

            // Zoom con dedos (pellizcar)
            let initialDistance = null;

            document.addEventListener("touchmove", (event) => {
                if (event.touches.length === 2) {
                    const [touch1, touch2] = event.touches;
                    const dx = touch1.clientX - touch2.clientX;
                    const dy = touch1.clientY - touch2.clientY;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (initialDistance === null) {
                        initialDistance = distance;
                    }

                    const delta = (distance - initialDistance) * 0.05;
                    let fov = parseFloat(cameraEl.getAttribute("fov"));
                    fov -= delta;
                    fov = Math.max(30, Math.min(120, fov)); // Limitar zoom entre 30 y 120
                    cameraEl.setAttribute("fov", fov);
                    initialDistance = distance;
                }
            });

            document.addEventListener("touchend", () => {
                initialDistance = null;
            });

            // Función para mostrar el modal de ayuda
            function showHelp() {
                document.getElementById("help-modal").style.display = "flex";
            }
            
            function closeHelp() {
                document.getElementById("help-modal").style.display = "none";
            }

            // Cerrar el modal cuando el usuario haga clic fuera del contenido del modal
            window.onclick = function(event) {
                const modal = document.getElementById("help-modal");
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }
        </script>
    </body>
</html